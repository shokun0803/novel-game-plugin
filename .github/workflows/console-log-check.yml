name: Console log check

on:
  push:
    branches:
      - dev
      - master
    paths:
      - 'js/**/*.js'
  pull_request:
    branches:
      - dev
      - master
    paths:
      - 'js/**/*.js'

permissions:
  contents: read

jobs:
  # JavaScript コードの静的チェック（grep ベース）
  grep-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for forbidden patterns in JS files
        run: |
          echo "Checking JavaScript files for forbidden patterns..."
          echo ""

          FORBIDDEN_FOUND=0

          # ========================================
          # 1. Check for forbidden console.* usage
          # ========================================
          echo "1. Checking for forbidden console.* usage..."
          
          # Allowed patterns:
          # - debugLog function implementation in debug-log.js
          # - Initialization shims with try-catch (try { console.* } catch)
          # - window.novelGameShowFlags and window.novelGameSetDebug functions
          # - Documentation/comments (* console.log)

          for file in $(find js -name "*.js" -type f ! -name "debug-log.js"); do
            while IFS= read -r match; do
              line_num=$(echo "$match" | cut -d: -f1)
              line_content=$(echo "$match" | cut -d: -f2-)

              # Skip allowed patterns
              # 1. Try-catch initialization shims
              if echo "$line_content" | grep -q 'try {.*console\.'; then
                continue
              fi

              # 2. Documentation comments
              if echo "$line_content" | grep -qE '^\s*\*'; then
                continue
              fi

              # 3. novelGameShowFlags and novelGameSetDebug are allowed to use console directly
              start_line=$((line_num - 20))
              if [ $start_line -lt 1 ]; then
                start_line=1
              fi
              context=$(sed -n "${start_line},${line_num}p" "$file")
              if echo "$context" | grep -qE 'window\.novelGameShowFlags\s*=\s*function|window\.novelGameSetDebug\s*=\s*function'; then
                continue
              fi

              # If we reach here, it's a forbidden usage
              echo "❌ Forbidden console usage found in $file:$line_num"
              echo "   $line_content"
              FORBIDDEN_FOUND=1

            done < <(grep -n 'console\.\(log\|warn\|error\)' "$file" 2>/dev/null || true)
          done

          # ========================================
          # 2. Check for eval() usage
          # ========================================
          echo ""
          echo "2. Checking for eval() usage..."
          
          for file in $(find js -name "*.js" -type f); do
            while IFS= read -r match; do
              line_num=$(echo "$match" | cut -d: -f1)
              line_content=$(echo "$match" | cut -d: -f2-)

              # Skip comments
              if echo "$line_content" | grep -qE '^\s*(//|\*)'; then
                continue
              fi

              echo "❌ Dangerous eval() found in $file:$line_num"
              echo "   $line_content"
              FORBIDDEN_FOUND=1

            done < <(grep -n '\beval\s*(' "$file" 2>/dev/null || true)
          done

          # ========================================
          # 3. Check for innerHTML usage (potential XSS)
          # ========================================
          echo ""
          echo "3. Checking for innerHTML usage..."
          
          for file in $(find js -name "*.js" -type f); do
            while IFS= read -r match; do
              line_num=$(echo "$match" | cut -d: -f1)
              line_content=$(echo "$match" | cut -d: -f2-)

              # Skip comments
              if echo "$line_content" | grep -qE '^\s*(//|\*)'; then
                continue
              fi

              # Check if using textContent or proper escaping - if so, allow
              # This is a warning, not an error
              echo "⚠️  innerHTML usage found in $file:$line_num (verify proper escaping)"
              echo "   $line_content"

            done < <(grep -n '\.innerHTML\s*=' "$file" 2>/dev/null || true)
          done

          # ========================================
          # Results
          # ========================================
          echo ""
          if [ $FORBIDDEN_FOUND -eq 1 ]; then
            echo "=========================================="
            echo "ERROR: Forbidden patterns detected!"
            echo ""
            echo "Guidelines:"
            echo "  - Use debugLog() instead of console.*"
            echo "  - Avoid eval() - use safer alternatives"
            echo "  - Prefer textContent over innerHTML for XSS safety"
            echo ""
            echo "See docs/DEVELOPER_LOGGING_GUIDELINES.md for details."
            echo "=========================================="
            exit 1
          else
            echo "✅ No forbidden patterns found."
          fi

