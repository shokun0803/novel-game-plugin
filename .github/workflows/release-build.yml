---
name: Release Build

'on':
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'ã‚¿ã‚°åï¼ˆä¾‹: v1.3.0ï¼‰'
        required: true
        type: string

permissions:
  contents: write

jobs:
  build-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install prerequisites
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y zip rsync

      - name: ã‚¿ã‚°åã®å–å¾—
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG_NAME="${{ github.event.inputs.tag_name }}"
          else
            TAG_NAME="${GITHUB_REF#refs/tags/}"
          fi
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "version=${TAG_NAME#v}" >> $GITHUB_OUTPUT
          echo "Building release for tag: $TAG_NAME"

      - name: ãƒªãƒªãƒ¼ã‚¹ç”¨ ZIP ã®ãƒ“ãƒ«ãƒ‰
        run: |
          TAG="${{ steps.get_version.outputs.tag_name }}"
          bash scripts/build-release.sh "$TAG"

      - name: ã‚µãƒ³ãƒ—ãƒ«ç”»åƒ ZIP ã®ãƒ“ãƒ«ãƒ‰
        run: |
          TAG="${{ steps.get_version.outputs.tag_name }}"
          bash scripts/build-sample-images.sh "$TAG" --all

      - name: ãƒ“ãƒ«ãƒ‰æˆæžœç‰©ã®ç¢ºèª
        run: |
          TAG="${{ steps.get_version.outputs.tag_name }}"
          echo "Checking build artifacts..."
          ls -lh build/
          echo ""
          echo "Plugin ZIP contents preview:"
          unzip -l "build/novel-game-plugin-${TAG}.zip" | head -30
          echo ""
          echo "Plugin ZIP SHA256 checksum:"
          cat "build/novel-game-plugin-${TAG}.zip.sha256"
          echo ""
          if ls build/novel-game-plugin-sample-images-${TAG}*.zip 1> /dev/null 2>&1; then
            echo "Sample images ZIP files:"
            ls -lh build/novel-game-plugin-sample-images-${TAG}*.zip
            echo ""
            echo "Sample images ZIP SHA256 checksums:"
            cat build/novel-game-plugin-sample-images-${TAG}*.zip.sha256
          else
            echo "No sample images ZIP generated."
          fi

      - name: ãƒªãƒªãƒ¼ã‚¹ãƒŽãƒ¼ãƒˆã®ç”Ÿæˆ
        id: release_notes
        run: |
          TAG_NAME="${{ steps.get_version.outputs.tag_name }}"
          ZIP_NAME="novel-game-plugin-${TAG_NAME}.zip"
          SHA256=$(cat build/${ZIP_NAME}.sha256 | cut -d' ' -f1)

          cat > release-notes.md <<EOF
          ## ðŸ“¦ Novel Game Plugin ${TAG_NAME}

          WordPress ã«ç›´æŽ¥ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¯èƒ½ãªãƒ—ãƒ©ã‚°ã‚¤ãƒ³ ZIP ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚

          ### ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•

          1. ä¸‹è¨˜ã®ã‚¢ã‚»ãƒƒãƒˆã‹ã‚‰ \`${ZIP_NAME}\` ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          2. WordPress ç®¡ç†ç”»é¢ â†’ ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ â†’ æ–°è¦è¿½åŠ  â†’ ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
          3. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸ ZIP ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠžã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          4. ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’æœ‰åŠ¹åŒ–

          ### ðŸ” æ¤œè¨¼æ‰‹é †

          ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã®æ•´åˆæ€§ã‚’ç¢ºèªã™ã‚‹ã«ã¯ï¼š

          \`\`\`bash
          # SHA256 ãƒã‚§ãƒƒã‚¯ã‚µãƒ ã®æ¤œè¨¼
          sha256sum ${ZIP_NAME}
          # æœŸå¾…ã•ã‚Œã‚‹å€¤: ${SHA256}

          # ã¾ãŸã¯ã€ãƒã‚§ãƒƒã‚¯ã‚µãƒ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨
          sha256sum -c ${ZIP_NAME}.sha256
          \`\`\`

          ### ðŸ“‹ ãƒã‚§ãƒƒã‚¯ã‚µãƒ 

          \`\`\`
          SHA256: ${SHA256}
          \`\`\`

          ### âš ï¸ äº’æ›æ€§ã«ã¤ã„ã¦

          - **å¿…é ˆç’°å¢ƒ**: WordPress 4.7+, PHP 7.0+, MySQL 5.6+
          - **æŽ¨å¥¨ç’°å¢ƒ**: WordPress 6.0+, PHP 8.0+
          - **ãƒ†ã‚¹ãƒˆæ¸ˆã¿**: WordPress 6.0+

          ### ðŸ“ å¤‰æ›´å†…å®¹

          è©³ç´°ãªå¤‰æ›´å±¥æ­´ã¯ [CHANGELOG.md](https://github.com/shokun0803/novel-game-plugin/blob/master/CHANGELOG.md) ã‚’ã”è¦§ãã ã•ã„ã€‚

          ### ðŸ› å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆ

          - [Issues](https://github.com/shokun0803/novel-game-plugin/issues) ã§æ—¢å­˜ã®å•é¡Œã‚’ç¢ºèª
          - æ–°ã—ã„å•é¡Œã‚’å ±å‘Šã™ã‚‹å ´åˆã¯ Issue ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ã”åˆ©ç”¨ãã ã•ã„

          ### ðŸ“š ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

          - [README.md](https://github.com/shokun0803/novel-game-plugin/blob/master/README.md) - ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ä½¿ã„æ–¹
          - [ãƒªãƒªãƒ¼ã‚¹ãƒ—ãƒ­ã‚»ã‚¹](https://github.com/shokun0803/novel-game-plugin/blob/master/docs/RELEASE_PROCESS.md) - ãƒªãƒªãƒ¼ã‚¹æ‰‹é †
          EOF

          echo "Release notes generated."

      - name: GitHub Release ã®ä½œæˆ
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.tag_name }}
          name: >-
            Novel Game Plugin
            ${{ steps.get_version.outputs.tag_name }}
          body_path: release-notes.md
          files: |
            build/novel-game-plugin-${{ steps.get_version.outputs.tag_name }}.zip
            build/novel-game-plugin-${{ steps.get_version.outputs.tag_name }}.zip.sha256
            build/novel-game-plugin-sample-images-${{ steps.get_version.outputs.tag_name }}-*.zip
            build/novel-game-plugin-sample-images-${{ steps.get_version.outputs.tag_name }}-*.zip.sha256
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ãƒ“ãƒ«ãƒ‰å®Œäº†é€šçŸ¥
        run: |
          TAG="${{ steps.get_version.outputs.tag_name }}"
          VERSION="${{ steps.get_version.outputs.version }}"
          REPO="${{ github.repository }}"
          echo "=========================================="
          echo "âœ… Release build completed successfully!"
          echo "=========================================="
          echo ""
          echo "Tag: ${TAG}"
          echo "Version: ${VERSION}"
          echo ""
          echo "Release URL:"
          echo "https://github.com/${REPO}/releases/tag/${TAG}"
