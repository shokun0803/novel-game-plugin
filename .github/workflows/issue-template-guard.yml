name: Issue template guard

on:
  issues:
    types: [opened, edited]

permissions:
  issues: write

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Check required headings and references
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body || "";
            const labels = (context.payload.issue.labels || []).map(l => l.name);
            const problems = [];

            // Select required headings based on label
            let required = [];
            let requiredSubHeadings = [];

            if (labels.includes('bug')) {
              // Bug-specific required headings
              required = ["# タイトル", "## 概要", "## 再現手順", "## チェックリスト", "## 重要事項", "## 参考"];
              requiredSubHeadings = [];
            } else if (labels.includes('enhancement') || labels.includes('feature')) {
              // Enhancement/feature-specific required headings with detailed subheadings
              required = ["# タイトル", "## 概要", "## 要件", "## チェックリスト", "## 重要事項", "## 参考"];
              requiredSubHeadings = ["### 機能仕様", "### UI/文言", "### 互換性/移行", "### 実装影響範囲", "### テスト観点"];
            } else {
              // Default: require a minimal set and include the feature subheadings by default
              required = ["# タイトル", "## 概要", "## チェックリスト", "## 重要事項", "## 参考"];
              requiredSubHeadings = [];
            }

            // Validate top-level headings
            for (const h of required) {
              if (!body.includes(h)) problems.push(`必須見出しが不足: ${h}`);
            }
            // Required sub-headings under "## 要件"
            for (const sh of requiredSubHeadings) {
              if (!body.includes(sh)) problems.push(`要件セクションに必須サブ見出しが不足: ${sh}`);
            }
            // Forbidden tokens (posting safety)
            const forbidden = ["\n\n$"]; // minimal placeholder; avoid accidental $ after double newline
            for (const f of forbidden) {
              if (body.includes(f)) problems.push(`禁止トークンを検出: ${f}`);
            }
            // Fixed reference must exist
            if (!body.includes(".github/copilot-instructions.md")) {
              problems.push("参考に固定の運用規約リンクがありません: .github/copilot-instructions.md");
            }
            if (problems.length === 0) return;
            const issue_number = context.payload.issue.number;
            const msg = [
              "Issue テンプレート準拠チェックに失敗しました。以下を修正してください:",
              "",
              ...problems.map(p => `- ${p}`),
              "",
              "SOP: .github/ISSUE_CREATION_SOP.md を参照してください。"
            ].join("\n");
            await github.rest.issues.createComment({
              ...context.repo,
              issue_number,
              body: msg,
            });
            await github.rest.issues.addLabels({
              ...context.repo,
              issue_number,
              labels: ["needs-template-fix"]
            });
