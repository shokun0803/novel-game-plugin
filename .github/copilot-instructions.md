<!-- I want to review in Japanese. -->

## ブランチ運用ポリシー（Git Workflow）

本リポジトリでは以下のポリシーに基づきブランチ運用を行います。GitHub Copilot はこれを常に参照し、指示がない限り逸脱した操作（不要な push / force-push / dev への直接コミット 等）を行わないこと。

### ブランチ種別と役割

- `master`: リリース済み安定版。WordPress 公式公開を意識した基準ブランチ。直接コミット禁止。`dev` からの明示的マージのみ。
- `dev`: 統合開発ブランチ。進行中 PR の変更を段階的に取り込み検証する場。**リモートでは常に `master` と同期状態を基本とし、ローカルでのみ PR ブランチをマージして動作検証を行う**。
	- すべての新規プルリクエストの **base (比較先)** として使用する。GitHub Copilot Agent は PR 作成時に `master` を base に選択してはならない。
- `feature/<name>` / `fix/<name>` / `chore/<name>` など: 個別機能・修正用一時ブランチ。作業完了後 PR 作成 → dev へマージ後速やかに削除。
- `pr-<number>` や `copilot/fix-<issue>`: 自動生成/一時用途。dev へ取り込み次第ローカル削除。リモートに残っていても再利用しない。

### 基本フロー
1. 新機能開始時: `master` から一時ブランチ作成（例: `git checkout -b feature/flag-dialogue origin/master`）。
2. 実装 → ローカルで `dev` にマージ（検証用。リモートには push しない）。
3. 問題なければ一時ブランチを元に PR を作成（必ず base: `dev`。**`master` を base に指定することは禁止**）。
4. レビュー完了後: `dev` へマージ（--no-ff 推奨で履歴明確化）。
5. 定期的に `dev` が安定した段階で `master` にマージ（リリース）。
6. マージ済み一時ブランチはローカル/リモートとも削除。

### ローカル dev ブランチ運用ルール
- ローカル `dev` は進行中 PR の検証集約用として自由にマージ可（未完成でも可）。
- リモート `dev` は原則 `master` と同期状態を維持（= 余計な先行コミットを置かない）。
- リモート `dev` へ push / force-push は **明示指示がある場合のみ** 実行。

### 禁止事項（Copilot は自動で行わない）
- 指示なしの `git push origin dev`
- 指示なしの `--force` / `--force-with-lease`
- 安定ブランチ（`master`,`dev` リモート）への直接コミット
- 未確認 PR ブランチの勝手な rebase / squash

### マージポリシー
- PR マージは `--no-ff` を基本とし 1 PR = 1 マージコミットを保持。
- コンフリクト解消は専用一時ブランチで実施し、内容を最小限に限定。

### ブランチ削除基準
- `git branch --merged dev` で dev に完全マージ済みの一時ブランチのみ削除。
- 未マージ判定: `git log dev..<branch>` に出力があれば削除禁止。

### 例: ローカル検証手順（リモートに影響を与えない）
```bash
git fetch --prune
git checkout dev
git merge --no-ff origin/feature/xxx   # ここで検証
# 動作確認後 reset で元に戻せるよう必要なら一時タグ
git tag temp-dev-test-<date>
```

### 差分破棄とクリーンアップ例
```bash
git checkout dev
git reset --hard origin/dev
git branch --merged dev | grep -vE '^(\*|dev|master)$' | xargs -r -n1 git branch -d
```

### 🚨 VS Code GitHub Copilot Agent 専用規約

#### リモート操作の厳格制御
- **「ローカル」指示の場合：絶対にリモート操作（push/force-push）を含めない**
- **「ローカルマージ」＝リモートpush禁止**。一般的なGit運用として自動でpushしない
- **リモート操作は「リモートにpushしてください」等の明示指示がある場合のみ実行**

#### 作業完了時の報告義務
- **ローカル作業完了時：「リモート操作は実行していません」と明記**
- **リモート操作実行時：「リモート[ブランチ名]に反映済み」と明記**

#### 禁止コマンド（明示指示なしでは絶対実行禁止）
```bash
git push origin dev              # ❌ 明示指示なしでは絶対禁止
git push --force origin dev      # ❌ 明示指示なしでは絶対禁止  
git push --force-with-lease origin dev  # ❌ 明示指示なしでは絶対禁止
```

#### Git操作前チェックリスト
- [ ] リモート操作が含まれていないか？
- [ ] 明示的な「リモートpush」指示があるか？
- [ ] 「ローカル」指示の場合、ローカルのみで完結するか？

#### 提案・確認中の操作保留ルール
- **提案や修正案の提示後、ユーザーの確認・承認・実行指示があるまで操作（コミット・push・ファイル編集）を保留する**
- **確認中の段階では「修正指示」として扱わず、明示的な実行指示を待つ**
- **提案に対するユーザーの意見反映後、改めて実行指示を確認してから操作を実施**
- **各操作の指示は個別のクエリごとに明示的に確認し、以前の指示を継続して適用しない（例: 一度の push 指示が以降のクエリにも適用されない）**

### Copilot への追加指針
- 「リモートへ push して」等の明示文言が無い限り push しない。
- master/dev の履歴を書き換える操作は常にユーザー確認を要求。
- PR ブランチ削除前に必ず dev へのマージ有無を判定し結果を提示。
- PR 作成時: base ブランチに `dev` 以外（特に `master`）が自動選択されている場合は作成を中断し、ユーザーへ `dev` への変更を促す。
- 既存 PR が `master` を base にしている場合: 直ちにコメントで `dev` へのリターゲットを提案し、自動マージ・レビューを進めない。
- 前提: `master` は「公開用」、`dev` は「開発統合用」。`master` 直マージをトリガーするブラウザ上の Merge ボタン操作を誘発する挙動を避ける。

---
（この節はリポジトリ運用規約の一部であり、変更が必要な場合は別途 PR を作成してください）

# copilot-instructions.md

## プロジェクト概要

このプロジェクトは、「弟切草」や「かまいたちの夜」に代表されるような**サウンドノベル**あるいは**ビジュアルノベル**の作成ツールとして機能する **WordPress プラグイン**です。  
ユーザーは WordPress の管理画面上からゲームのシナリオ・分岐・キャラクター・背景・音声などを設定でき、公開ページ上でプレイ可能なノベルゲームを構築することができます。  
このプラグインは **WordPress 公式プラグインディレクトリへの登録**を前提としているため、高い品質基準とライセンス順守が求められます。

## GitHub Copilot への指示
<!-- for GitHub Copilot review rule-->

### ✅ コーディング規約に関する指示

- WordPress の[公式コーディング規約](https://developer.wordpress.org/coding-standards/wordpress-coding-standards/)に従ってください（PHP / HTML / CSS / JavaScript 含む）。
- PHP のインデントはスペース4つ、関数・変数・定数の命名にはスネークケースを使用。
- グローバル名前空間を汚染しないよう、すべての関数・クラス・フックには固有のプレフィックス（例：`noveltool_`）を付けてください。
- アクション・フィルターを使用する際には、正しい優先度と引数数を設定してください。
- CSS には !important は原則使用しない。 CSS の仕様に合わせたセレクタによる点数計算で優先順位を設定してください。
- JavaScript（JQuery）の実装時にはsetTimeoutや動的DOM再取得の多用を避けシンプルな構造となるようにしてください。

### ✅ ライセンスとセキュリティに関する指示

- すべてのコードは **GPLv2 互換ライセンス**に準拠してください。
- 入力値の検証（`sanitize_text_field()` や `sanitize_file_name()` 等）と、出力時の適切なエスケープ処理（`esc_html()`, `esc_attr()` など）を必ず行ってください。
- データベースへのクエリには `$wpdb->prepare()` を使用し、SQLインジェクションを防止してください。
- 管理画面における処理には `current_user_can()` による権限チェックを加えてください。

### ✅ コメント・ドキュメントに関する指示

- **すべてのコメントは日本語で記述**してください。
- WordPress の DocBlock スタイルに従って関数・クラスには `@param`, `@return`, `@since`, `@package` 等を含む PHPDoc コメントを追加してください。
- 他の開発者や将来の自分が理解しやすいように、コードの意図を明確に説明してください。

### ✅ プルリクエストの作成・運用に関する指示

- **すべてのプルリクエストは日本語で記述**してください。
- 一度作成したプルリクエストのタイトルや概要の内容を追加修正に伴って変更することは行わないでください。
- プルリクエストの機能追加、バグ修正に伴って正常動作している機能を損なわないように細心の注意を払ってください。
- プルリクエストは dev ブランチを元に作成し、マージする際にも dev ブランチに実施するように行ってください。
 - テンプレート上の見出しに括弧付きの「（必須）」「（任意）」「（固定）」等は付けない（必須性は運用ルールで担保）。
 - PRタイトルは最初の行に見出し無しで直接記載（`#` 見出し禁止）。
 - PR テンプレートには「重要事項」セクションを重複掲載しない（内容は中央集約し本ファイルで参照）。
 - 進捗/報告専用の新規ドキュメントをPR目的だけで作成しない。READMEや既存仕様/ルール変更がある場合のみ必要最小限更新。

### コメント主導レビューポリシー（Comment-driven Review Policy）

このリポジトリでは、レビュー対象や確認対象の範囲を明確にするため、以下の『コメント主導レビューポリシー』を適用します。

1. まず、リモートの最新のコメントとコミットを必ず取得して状況を把握してください（`git fetch origin` / `gh pr view <番号> --comments` 等で最新情報を取得）。
2. ユーザー（またはオーナー）による最新のコメント（以下「anchor コメント」）を基準にレビュー対象を決定します。anchor コメントに対する最新の 'reply'（返答コメント）を取得してください。
3. 返信コメント内にコミットハッシュ（7 文字以上）が明記されている場合、**そのコミットすべて**を直接レビュー対象として扱います。
4. 返信コメント内に明示的なコミットハッシュがない場合は、anchor コメントの作成日時（`createdAt`）から reply コメントの作成日時までの間に PR ブランチ上でコミットされた差分（`git log --since=.. --until=`）を対象としてください。
5. 1 つの reply が複数のコミットを含む場合、それらすべてをレビューしてください（コミット単位の差分で問題が無いかを確認します）。
6. 翻訳のみ（`.pot` / `.po` / `.mo` / ローカライズファイル）に関するコミットの場合、原則として翻訳ファイルと UI 文言の整合性（`__()` 等の i18n 関数が適切に使われているか、POT に抽出されているか）だけをチェックします。既にレビュー済みのロジック（コード本体）が変更されていない限り、重複してコードロジックを再レビューしないでください。
7. 編集・コミット・push（リモート操作）は**必ず**ユーザーの明示的許可がある場合にのみ行ってください。ローカルでの検証やブランチ作成は許可されていますが、リモートへ push する操作は行わないでください（`dev` へ push しない）。
8. 例外: セキュリティやデータ削除に関わる重大な挙動が差分に見られる場合、anchor 範囲内に限り追加で関連ファイル（権限、DB、アンインストール処理など）を確認し、問題あれば即座にユーザーへ報告します。これは **差分の最小限確認** に限定すること。

実行例（注: 読み取りのみ）:
```bash
# anchor コメントを取得し、reply を選択
ANCHOR_ID="IC_kwDOPI23ec7YYK4S"
ANCHOR_CREATED=$(gh pr view 206 --repo shokun0803/novel-game-plugin --comments --json comments --jq ".comments | map(select(.id == \"$ANCHOR_ID\")) | .[0].createdAt")
REPLY_JSON=$(gh pr view 206 --repo shokun0803/novel-game-plugin --comments --json comments --jq ".comments | map(select(.inReplyToId == \"$ANCHOR_ID\")) | sort_by(.createdAt) | .[-1]")
REPLY_CREATED=$(echo "$REPLY_JSON" | jq -r '.createdAt')

# 明示ハッシュがない場合: anchor~reply のコミットを抽出
git log --pretty=format:'%cI %h %s' origin/pr-206 --since="$ANCHOR_CREATED" --until="$REPLY_CREATED"
```

注: 上記操作は**読み取り専用**の確認であり、編集や push は行いません。必要であればパッチ作成は別途指示してください。


#### ファイル操作の基本方針

- **明示的な指示がない限り、ファイルの作成・編集・削除は実行しない**
  - 「修正してください」「変更してください」等の明示的な指示がある場合のみファイル操作を実行
  - レビュー依頼や確認依頼の場合は、ファイルを変更せずチャット内で報告
  - 提案や推奨事項の提示は可能だが、実装は明示的指示後に実行

#### GitHub Copilot Agent へのコメント投稿ルール

- **PRコメント投稿は明示的な指示がある場合のみ実行**
  - 「PRにコメントしてください」「GitHubに投稿してください」等の明示的な指示がない限り、PRへのコメント投稿は行わない
  - リモート操作（push/force-push）と同様に、コメント投稿もリモートへの干渉として扱う
  - レビュー結果や修正提案はチャット内で報告し、投稿指示があった場合のみGitHubへ投稿
- **コメント投稿後は即座に実装が開始される前提で動く**
  - @copilot メンションでのコメント投稿 = 実装作業開始のトリガー
  - 投稿した内容は既に作業中として扱う
- **追加の修正指示は差分のみを記載**
  - 前回投稿したコメント内容と重複する指示は絶対に避ける
  - 「前回の指示に追加で」「前回コメントで指示した内容に加えて」等で差分を明確化
  - 新規の修正ポイントのみを具体的に記載
- **最初のコメントで修正内容全体を網羅**
  - 一度の投稿で必要な修正指示をすべて含める
  - 段階的な指示は避け、完全な修正内容を一度に提示
- **投稿前の確認必須**
  - 既に投稿したコメントの内容を確認
  - 重複・矛盾のチェック
  - 過去の実装済みコミットとの整合性確認

### ✅ 国際化・多言語対応

- すべての表示テキストには翻訳関数 `__()`, `_e()`, `_x()` などを使用してください。
- テキストドメインにはプラグイン固有のドメイン（例：`noveltool`）を使用してください。
- 翻訳用ファイル（.pot / .po / .mo）を生成することを前提とした設計にしてください。

<!-- for GitHub Copilot review rule-->

<!-- I want to review in Japanese. -->
