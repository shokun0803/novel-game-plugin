# サンプル画像ダウンロードUI テストガイド

## テスト概要

本テストでは、以下の機能が正しく動作することを確認します：

1. リアルタイム進捗表示（XHR onprogress）
2. バックグラウンド処理へのフォールバック
3. 進捗バナーの表示と更新
4. JavaScript無効時のフォールバック
5. 低メモリ環境での動作
6. 短い max_execution_time 環境での動作

## テスト環境

### 標準環境
- PHP 7.4以上
- memory_limit: 256M以上
- max_execution_time: 60秒以上
- JavaScript有効

### 低リソース環境
- PHP 7.4以上
- memory_limit: 128M
- max_execution_time: 30秒
- JavaScript有効

### JavaScript無効環境
- 標準環境
- JavaScriptを無効化

## テストケース

### 1. 初回ダウンロードモーダル表示

**前提条件:**
- プラグイン有効化直後
- サンプル画像未インストール
- 管理者権限でログイン

**手順:**
1. マイゲームページにアクセス
2. 500ms後にモーダルが表示されることを確認

**期待結果:**
- モーダルが表示される
- ダウンロードボタン、後でボタン、キャンセルボタンが表示される
- 適切な説明文が表示される

### 2. リアルタイム進捗表示（理想ケース）

**前提条件:**
- サンプル画像未インストール
- サーバーがストリーミング進捗をサポート（Content-Lengthヘッダー送信）

**手順:**
1. マイゲームページからダウンロードモーダルを表示
2. 「ダウンロード」ボタンをクリック
3. プログレスバーの表示を確認

**期待結果:**
- プログレスバーが表示される
- パーセンテージが0%から100%まで増加する
- ステータステキストが適切に更新される（「接続中...」→「ダウンロード中...」→「完了」）
- 完了後、成功メッセージが表示される

### 3. バックグラウンド処理フォールバック

**前提条件:**
- サンプル画像未インストール
- サーバーがストリーミング進捗を提供しない、またはタイムアウト

**手順:**
1. マイゲームページからダウンロードモーダルを表示
2. 「ダウンロード」ボタンをクリック
3. 5秒後に自動的にポーリングモードへ切り替わることを確認

**期待結果:**
- 初期は接続中のメッセージが表示される
- 5秒後、indeterminateプログレスバー（アニメーション）に切り替わる
- 3秒ごとにステータスをポーリングして進捗を更新
- ステータスが「in_progress」の間、適切なメッセージを表示（「ダウンロード中...」「検証中...」「展開中...」）
- 完了後、成功メッセージが表示される

### 4. 進捗バナーの表示

**前提条件:**
- ダウンロードがバックグラウンドで進行中
- user_metaにジョブIDが保存されている

**手順:**
1. ダウンロード開始後、別のページへ移動
2. マイゲームページに戻る
3. 進捗バナーが表示されることを確認

**期待結果:**
- ページ上部（h1直下）に進捗バナーが表示される
- プログレスバーが表示され、現在の進捗を表示
- 「詳細を表示」ボタンが機能する
- バックグラウンド処理中は3秒ごとに自動更新される

### 5. 進捗バナーの完了表示

**前提条件:**
- ダウンロードが完了した状態
- user_metaにジョブIDが保存されている

**手順:**
1. ダウンロード完了後にマイゲームページにアクセス
2. バナーの表示を確認

**期待結果:**
- バナーが success スタイルで表示される
- 完了メッセージが表示される
- 「閉じる」ボタンをクリックするとバナーが消え、ページがリロードされる
- ジョブIDがuser_metaから削除される

### 6. JavaScript無効時のフォールバック

**前提条件:**
- JavaScriptを無効化
- サンプル画像未インストール

**手順:**
1. マイゲームページにアクセス
2. noscriptタグ内のメッセージを確認

**期待結果:**
- 警告メッセージが表示される（「JavaScript is disabled...」）
- ダウンロードボタンは表示されるが、クリックしてもalertが表示される
- リアルタイム進捗は表示されない

### 7. 低メモリ環境でのダウンロード

**前提条件:**
- memory_limit: 128M
- サンプル画像サイズ: 約15MB

**手順:**
1. php.iniで`memory_limit = 128M`を設定
2. マイゲームページからダウンロードを開始
3. ダウンロードが完了するまで監視

**期待結果:**
- ダウンロードが正常に完了する
- メモリ不足エラーが発生しない（ログに警告は記録される可能性あり）
- バックグラウンド処理により、メモリ使用量が管理される

### 8. 短いmax_execution_time環境でのダウンロード

**前提条件:**
- max_execution_time: 30秒
- サンプル画像サイズ: 約15MB（30秒以内に完了しない可能性）

**手順:**
1. php.iniで`max_execution_time = 30`を設定
2. マイゲームページからダウンロードを開始
3. ダウンロードが完了するまで監視

**期待結果:**
- 初回リクエストがタイムアウトしても、バックグラウンドジョブが継続
- ポーリングにより進捗が確認できる
- 最終的にダウンロードが完了する

### 9. エラーハンドリング

**前提条件:**
- ネットワークエラーまたはサーバーエラーを模擬

**手順:**
1. ネットワークを一時的に切断、またはサーバーでエラーを発生させる
2. ダウンロードを開始
3. エラーメッセージの表示を確認

**期待結果:**
- エラーメッセージが表示される
- エラー詳細（エラーコード、ステージ、タイムスタンプ）が展開可能
- トラブルシューティング手順が表示される
- 再試行ボタンが機能する

### 10. 複数アセットダウンロード

**前提条件:**
- リリースに複数のサンプル画像ZIPファイルが存在

**手順:**
1. ダウンロードを開始
2. 各アセットのダウンロード進捗を確認

**期待結果:**
- 全アセットが順次ダウンロードされる
- 進捗バーが全体の進捗を反映
- 一部のアセットが失敗しても、他のアセットは継続される
- 完了後、失敗したアセット一覧が表示される（該当する場合）

## 自動テスト

現在、手動テストのみサポートしています。将来的には以下の自動テストを追加する予定です：

- PHPUnit: サーバー側ロジックのテスト
- Jest: JavaScript関数のテスト
- Playwright: E2Eテスト

## テスト結果の記録

各テストケースの結果は以下の形式で記録してください：

```
テストケース: [ケース名]
日時: [YYYY-MM-DD HH:MM:SS]
環境: [環境詳細]
結果: [成功/失敗]
備考: [追加情報]
```

## トラブルシューティング

### プログレスバーが表示されない
- ブラウザの開発者ツールでコンソールエラーを確認
- nonceが正しく生成されているか確認
- REST APIエンドポイントにアクセスできるか確認

### ダウンロードが完了しない
- PHPエラーログを確認
- `noveltool_sample_images_download_status`オプションを確認
- `noveltool_background_jobs`オプションを確認
- WP Cronが正常に動作しているか確認

### バナーが表示されない
- user_metaに`noveltool_download_job_id`が保存されているか確認
- ダウンロードステータスが`in_progress`か確認
- 管理者権限があるか確認

## 参考情報

- Issue: https://github.com/shokun0803/novel-game-plugin/issues/[issue_number]
- PR: https://github.com/shokun0803/novel-game-plugin/pull/[pr_number]
- 実装詳細: I18N_UPDATE_NOTES.md
