# リビジョン機能テストシナリオ

このドキュメントでは、実装したリビジョン機能の動作確認手順を説明します。

## テスト環境

- WordPress 4.7以上
- novel-game-plugin 1.2.0以上がインストール済み

## テストシナリオ1: リビジョンの作成

### 目的
投稿保存時にカスタムメタを含むリビジョンが正しく作成されることを確認

### 手順
1. WordPress管理画面にログイン
2. 「ノベルゲーム」→「新規追加」をクリック
3. 以下のデータを入力：
   - タイトル: "テストシーン1"
   - ゲームタイトル: "テストゲーム"
   - 背景画像: 任意の画像を選択
   - セリフ: "これはテストセリフです。"
   - 選択肢: 何か選択肢を追加
4. 「公開」ボタンをクリック
5. 再度編集画面を開く
6. セリフを変更: "これは変更後のセリフです。"
7. 「更新」ボタンをクリック

### 期待される結果
- 画面右側の「リビジョン」メタボックスに2つのリビジョンが表示される
- 各リビジョンに日時とユーザー名が表示される

### 確認方法
- データベースで確認:
```sql
-- リビジョン投稿の確認
SELECT * FROM wp_posts WHERE post_type = 'revision' AND post_parent = [投稿ID];

-- リビジョンのメタデータ確認
SELECT * FROM wp_postmeta WHERE post_id IN (
  SELECT ID FROM wp_posts WHERE post_type = 'revision' AND post_parent = [投稿ID]
);
```

## テストシナリオ2: リビジョン比較

### 目的
リビジョン比較画面でカスタムメタの差分が表示されることを確認

### 手順
1. テストシナリオ1で作成した投稿の編集画面を開く
2. 「リビジョン」メタボックスの「リビジョンを参照」をクリック
3. リビジョン比較画面が開く
4. スライダーを動かして異なるリビジョンを比較

### 期待される結果
- タイトルの差分が表示される
- カスタムフィールド（セリフテキストなど）の差分が表示される
- 変更箇所がハイライト表示される

## テストシナリオ3: リビジョンの復元

### 目的
リビジョン復元時にすべてのカスタムメタが正しく復元されることを確認

### 手順
1. テストシナリオ1で作成した投稿の編集画面を開く
2. さらに変更を加える：
   - セリフ: "これは3回目の変更です。"
   - 背景画像: 別の画像に変更
   - 選択肢: 新しい選択肢を追加
3. 「更新」をクリック
4. 「リビジョン」メタボックスから「リビジョンを参照」をクリック
5. 最初のバージョン（初回保存時）を選択
6. 「このリビジョンを復元」ボタンをクリック
7. 編集画面に戻る

### 期待される結果
- セリフが最初のバージョン "これはテストセリフです。" に戻る
- 背景画像が最初に設定した画像に戻る
- 選択肢が最初の状態に戻る
- すべてのカスタムメタが最初のバージョンに戻る

### 確認方法
各フィールドの値を目視確認：
- [ ] タイトル
- [ ] ゲームタイトル
- [ ] 背景画像URL
- [ ] セリフテキスト
- [ ] 選択肢の内容
- [ ] キャラクター画像（設定している場合）
- [ ] エンディング設定（設定している場合）

## テストシナリオ4: 複雑なデータの復元

### 目的
JSON形式のカスタムメタ（選択肢のフラグ設定など）が正しく復元されることを確認

### 手順
1. 新しい投稿を作成
2. フラグ設定を含む選択肢を作成：
   - 選択肢1: "選択肢A" → 次のシーンID: XXX、設定フラグ: "flag_a"
   - 選択肢2: "選択肢B" → 次のシーンID: YYY、設定フラグ: "flag_b"
3. 保存
4. フラグ設定を変更：
   - 選択肢1の設定フラグを "flag_a_modified" に変更
5. 保存
6. リビジョンから最初のバージョンを復元

### 期待される結果
- 選択肢のフラグ設定が "flag_a" に戻る
- JSONデータが正しく復元される

### 確認方法
- 選択肢編集画面でフラグ設定を確認
- ブラウザの開発者ツールでJSONデータを確認

## テストシナリオ5: セリフフラグ条件の復元

### 目的
セリフレベルのフラグ条件が正しく復元されることを確認

### 手順
1. 新しい投稿を作成
2. セリフを複数追加
3. 一部のセリフにフラグ条件を設定
4. 保存
5. フラグ条件を変更または削除
6. 保存
7. リビジョンから最初のバージョンを復元

### 期待される結果
- セリフのフラグ条件が最初の設定に戻る
- フラグ条件のロジック（AND/OR）も正しく復元される

## テストシナリオ6: エンディング設定の復元

### 目的
エンディング設定が正しく復元されることを確認

### 手順
1. 新しい投稿を作成
2. エンディング設定をONにする
3. エンディングテキストを "エンディング1" に設定
4. 保存
5. エンディングテキストを "エンディング2" に変更
6. 保存
7. リビジョンから最初のバージョンを復元

### 期待される結果
- エンディング設定がONのまま
- エンディングテキストが "エンディング1" に戻る

## トラブルシューティング

### リビジョンが作成されない場合
1. WordPressのリビジョン機能が有効か確認
   - `wp-config.php` で `define('WP_POST_REVISIONS', false);` が設定されていないか確認
2. プラグインが正しく有効化されているか確認
3. WordPressのバージョンを確認（4.7以上が必要）

### リビジョン復元時にデータが戻らない場合
1. ブラウザのコンソールにエラーが表示されていないか確認
2. WordPressのデバッグモードを有効にしてエラーログを確認
3. データベースでリビジョンのメタデータが正しく保存されているか確認

### パフォーマンスの問題
1. リビジョン数を制限する（`wp-config.php` で `define('WP_POST_REVISIONS', 5);` など）
2. 古いリビジョンを削除するプラグインを使用

## 自動テスト（オプション）

PHPUnitを使用した自動テストの例：

```php
class RevisionTest extends WP_UnitTestCase {
    
    public function test_revision_saves_custom_meta() {
        // 投稿を作成
        $post_id = wp_insert_post(array(
            'post_type' => 'novel_game',
            'post_title' => 'Test Post',
            'post_status' => 'publish'
        ));
        
        // カスタムメタを設定
        update_post_meta($post_id, '_dialogue_text', 'Test dialogue');
        update_post_meta($post_id, '_game_title', 'Test Game');
        
        // リビジョンを作成
        $revision_id = wp_save_post_revision($post_id);
        
        // リビジョンにメタデータが保存されていることを確認
        $this->assertEquals(
            'Test dialogue',
            get_metadata('post', $revision_id, '_dialogue_text', true)
        );
        $this->assertEquals(
            'Test Game',
            get_metadata('post', $revision_id, '_game_title', true)
        );
    }
    
    public function test_revision_restore_custom_meta() {
        // 投稿を作成
        $post_id = wp_insert_post(array(
            'post_type' => 'novel_game',
            'post_title' => 'Test Post',
            'post_status' => 'publish'
        ));
        
        // 初期メタを設定
        update_post_meta($post_id, '_dialogue_text', 'Original dialogue');
        
        // リビジョンを作成
        $revision_id = wp_save_post_revision($post_id);
        
        // メタを変更
        update_post_meta($post_id, '_dialogue_text', 'Modified dialogue');
        
        // リビジョンを復元
        wp_restore_post_revision($revision_id);
        
        // メタが元に戻っていることを確認
        $this->assertEquals(
            'Original dialogue',
            get_post_meta($post_id, '_dialogue_text', true)
        );
    }
}
```

## 結論

すべてのテストシナリオが成功すれば、リビジョン機能は正しく実装されています。
問題が発生した場合は、トラブルシューティングセクションを参照してください。
