# リビジョン機能テストガイド

## 概要
このドキュメントでは、novel_game投稿タイプのリビジョン機能（特にカスタムメタ変更時の自動リビジョン作成）をテストする手順を説明します。

## 前提条件
- WordPress 4.7以上がインストールされていること
- Novel Game Pluginがインストール・有効化されていること
- ノベルゲーム投稿タイプが登録されていること
- 管理者権限でログインしていること

## テストシナリオ1: カスタムメタフィールド変更時のリビジョン作成

### 目的
カスタムメタフィールド（セリフ、選択肢等）のみを変更した場合にリビジョンが作成されることを確認します。

### 手順

#### 1. 新規投稿の作成
1. WordPressの管理画面にログイン
2. 「ノベルゲーム」→「新規追加」をクリック
3. タイトルを入力（例: "テストシーン1"）
4. シーンデータメタボックスで以下を設定:
   - ゲームタイトル: "テストゲーム"
   - 背景画像: 任意の画像を選択
   - セリフを追加: "これはテストセリフです"
5. 「公開」ボタンをクリック

#### 2. 初回リビジョンの確認
1. 投稿が保存されたことを確認
2. 右サイドバーの「リビジョン」メタボックスを確認
3. 初回保存のリビジョンが表示されることを確認

#### 3. カスタムメタのみを変更
1. **タイトルは変更せず**、シーンデータメタボックスのみを編集:
   - セリフを変更: "これは更新されたセリフです"
   - または新しいセリフを追加
   - または選択肢を追加
2. 「更新」ボタンをクリック

#### 4. リビジョンが作成されたことを確認
1. ページがリロードされることを確認
2. 右サイドバーの「リビジョン」メタボックスを確認
3. **新しいリビジョンが追加されていること**を確認
4. リビジョン数が増えていることを確認

### 期待される結果
✅ カスタムメタフィールドのみを変更した場合でも、新しいリビジョンが作成される
✅ リビジョンメタボックスに「X 個のリビジョン」と表示される
✅ 最新のリビジョンに現在の日時が表示される

### 失敗例（修正前の動作）
❌ カスタムメタフィールドのみを変更してもリビジョンが作成されない
❌ タイトルを変更しない限りリビジョンメタボックスが表示されない

## テストシナリオ2: リビジョンの復元

### 目的
過去のリビジョンを復元した際に、カスタムメタフィールドも正しく復元されることを確認します。

### 手順

#### 1. 複数のバージョンを作成
1. 投稿を開く
2. セリフを「バージョン1」に変更して保存
3. セリフを「バージョン2」に変更して保存
4. セリフを「バージョン3」に変更して保存

#### 2. リビジョンを確認
1. 「リビジョン」メタボックスをクリック
2. リビジョン比較画面が表示される
3. スライダーで過去のリビジョンを選択

#### 3. リビジョンを復元
1. 「バージョン1」のリビジョンを選択
2. 「このリビジョンを復元」ボタンをクリック
3. 投稿編集画面に戻る

#### 4. 復元内容を確認
1. シーンデータメタボックスを確認
2. セリフが「バージョン1」の内容に戻っていることを確認
3. 他のカスタムメタフィールドも正しく復元されていることを確認

### 期待される結果
✅ リビジョンを復元すると、すべてのカスタムメタフィールドが選択したバージョンの状態に戻る
✅ セリフ、選択肢、フラグ設定などがすべて正しく復元される
✅ 復元後、新しいリビジョンが作成される

## テストシナリオ3: post_excerpt の非表示確認

### 目的
リビジョン用の post_excerpt がフロントエンドやRSSに表示されないことを確認します。

### 手順

#### 1. フロントエンド表示の確認
1. カスタムメタを変更した投稿を保存
2. 投稿のプレビューまたは公開ページを表示
3. ページのソースコードを確認

### 期待される結果
✅ ページ上に「Novel meta updated: ...」のようなテキストが表示されない
✅ excerpt に関連するHTMLタグがあっても、内容が空である
✅ RSSフィードにも excerpt が表示されない

## テストシナリオ4: 無限ループの確認

### 目的
save_post フックの無限ループが発生しないことを確認します。

### 手順

#### 1. デバッグモードを有効化
1. wp-config.php に以下を追加:
```php
define( 'WP_DEBUG', true );
define( 'WP_DEBUG_LOG', true );
```

#### 2. 投稿を保存
1. カスタムメタフィールドを変更
2. 保存ボタンをクリック
3. ページの読み込みが完了するまで待つ

#### 3. ログを確認
1. wp-content/debug.log を確認
2. エラーや警告がないことを確認

### 期待される結果
✅ 保存処理が正常に完了する（タイムアウトしない）
✅ debug.log に無限ループを示すエラーがない
✅ メモリ不足エラーが発生しない

## トラブルシューティング

### リビジョンが作成されない場合

#### 確認事項
1. WordPressのリビジョン機能が有効になっているか確認
   - wp-config.php に `define('WP_POST_REVISIONS', false);` がないことを確認
   
2. プラグインが最新版か確認
   - プラグインのバージョンが 1.2.1 以上であることを確認

3. 投稿タイプが正しく登録されているか確認
   ```php
   // WordPress管理画面のツール→サイトヘルス→情報→投稿タイプで確認
   // novel_game の supports に 'excerpt' と 'revisions' が含まれているか
   ```

4. 権限を確認
   - 現在のユーザーが edit_post 権限を持っているか確認

### post_excerpt が表示される場合

#### 確認事項
1. テーマやプラグインが excerpt をカスタマイズしていないか確認
2. フィルタが正しく登録されているか確認:
   ```php
   // functions.php やプラグインに以下を追加して確認
   add_action('init', function() {
       global $wp_filter;
       var_dump($wp_filter['the_excerpt_rss']);
       var_dump($wp_filter['get_the_excerpt']);
   });
   ```

## まとめ

すべてのテストシナリオが成功した場合、リビジョン機能は正しく動作しています。

### 成功基準
- ✅ カスタムメタ変更時にリビジョンが自動作成される
- ✅ リビジョン復元時にすべてのカスタムメタが正しく復元される
- ✅ post_excerpt がフロントエンドに表示されない
- ✅ 無限ループが発生しない
- ✅ パフォーマンスに問題がない

### 報告
問題が発生した場合は、以下の情報とともにGitHubのIssueに報告してください:
- WordPressのバージョン
- プラグインのバージョン
- 使用しているテーマ
- 有効化している他のプラグイン
- エラーログの内容
- 再現手順
